version: '2.4'
services:

  # mongo:
  #   image: mongo:4.0.27-xenial
  #   restart: always
  #   container_name: mongo
  #   ports:
  #     - 27017:27017
  #   secrets:
  #     - mongo_initdb_root_username
  #     - mongo_initdb_root_password
  #     - mongo_username
  #     - mongo_password
  #   environment:
  #     - MONGO_INITDB_ROOT_USERNAME_FILE=/run/secrets/mongo_initdb_root_username
  #     - MONGO_INITDB_ROOT_PASSWORD_FILE=/run/secrets/mongo_initdb_root_password
  #     - MONGO_INITDB_DATABASE=admin
  #     - MONGO_USERNAME_FILE=/run/secrets/mongo_username
  #     - MONGO_PASSWORD_FILE=/run/secrets/mongo_password
  #     - MONGO_DATABASE=genart
  #     - TZ=Europe/Amsterdam
  #   volumes:
  #     - ./mongo-init.sh:/docker-entrypoint-initdb.d/mongo-init.sh:ro
  #     - persistent_data_mongo:/data/db
  #   healthcheck:
  #     test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
  #     interval: 3s
    
  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: filebrowser
    ports:
      - 4000:4000
    volumes:
      - persistent_data:/srv
      # you need to hash password yourself, see:
      # https://github.com/filebrowser/filebrowser/issues/381#issuecomment-653241530
      # login with "username" and "password"
      - ./filebrowser.json:/.filebrowser.json
    # see this comment, to be able to use different port as port 80 you need to change healthcheck, see:
    # https://github.com/filebrowser/filebrowser/pull/1409#issuecomment-895283609
    healthcheck:
      test: curl -f http://localhost:4000/health || exit 1

  example:
    image: alpine
    container_name: example
    command: sleep 1d
    volumes:
      - persistent_data:/mnt

  example_subfolder:
    image: alpine
    container_name: example_subfolder
    command: sleep 1d
    volumes:
      - persistent_data_subfolder:/mnt

  node:
    image: node
    container_name: node
    command: sleep 1d
    volumes:
      - persistent_data_node:/mnt

# secrets:
#   mongo_username:
#     file: ./secrets/mongo_username.txt
#   mongo_password:
#     file: ./secrets/mongo_password.txt
#   mongo_initdb_root_username:
#     file: ./secrets/mongo_initdb_root_username.txt
#   mongo_initdb_root_password:
#     file: ./secrets/mongo_initdb_root_password.txt

volumes:
  mongo_db:
  persistent_data:
    driver: s3fs
    driver_opts:
      s3fsopts: "url=https://ams3.digitaloceanspaces.com,use_path_request_style,nomultipart"
    name: "bm-db6"
  persistent_data_subfolder:
    driver: s3fs
    driver_opts:
      s3fsopts: "url=https://ams3.digitaloceanspaces.com,use_path_request_style,nomultipart"
    # you need to create the folder 'subfolder' ánd upload a random file through the Digital Ocean Spaces interface, else you'll get errors.
    name: "bm-db6/subfolder"
  persistent_data_node:
    driver: s3fs
    driver_opts:
    # for correct permissions, node needs uid and gid 1000
      s3fsopts: "allow_other,uid=1000,gid=1000,url=https://ams3.digitaloceanspaces.com,use_path_request_style,nomultipart"
    name: "bm-db6/node"
  # persistent_data_mongo:
  #   driver: s3fs
  #   driver_opts:
  #   # for correct permissions, mongo needs uid and gid 999
  #     s3fsopts: "allow_other,uid=999,gid=999,url=https://ams3.digitaloceanspaces.com,use_path_request_style,nomultipart"
  #   # you need to create the folder 'mongo' ánd upload a random file through the Digital Ocean Spaces interface, else you'll get errors.
  #   name: "bm-db6/mongo"
